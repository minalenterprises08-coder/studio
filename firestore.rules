/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for customer data and restricts product and invoice modifications to admins only.
 *
 * Data Structure:
 * - /roles_admin/{uid}: Indicates admin status based on document existence.
 * - /users/{userId}: Stores customer profile data, secured by path-based rules.
 * - /users/{userId}/orders/{orderId}: Orders belonging to a specific customer.
 * - /users/{userId}/dielines/{dielineId}: Dielines uploaded by a specific customer.
 * - /users/{userId}/dielines/{dielineId}/ai_reports/{aiReportId}: AI reports for a user's dieline.
 * - /products/{productId}: Product information, publicly readable, admin-writeable.
 * - /invoices/{invoiceId}: Invoice information, access control managed via security rules.
 * - /testimonials/{testimonialId}: User-submitted reviews.
 *
 * Key Security Decisions:
 * - Users can only access their own data (orders, dielines, AI reports).
 * - Only admins can create, update, or delete products.
 * - Invoices can only be read by admins and the associated user. Writes are restricted to admins.
 * - Any authenticated user can create a testimonial.
 * - Users can only update or delete their own testimonials.
 * - User listing is disallowed for privacy.
 *
 * Denormalization for Authorization:
 * - None needed; using path-based authorization and DBAC (Database-Based Access Control) with /roles_admin.
 *
 * Structural Segregation:
 * - User-specific data is stored under the /users/{userId} path for isolation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by an admin.
     * @return {boolean} True if the request is made by an admin, false otherwise.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user is the owner of the document based on the provided userId.
     * @param {string} userId - The user ID to check against the request's authentication UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the existing document.
     * @param {string} userId - The user ID to check against the existing document's user ID.
     * @return {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
    
    /**
     * @description Checks if the requesting user is the author of a resource.
     * @param {object} docResource - The resource document being accessed.
     * @return {boolean} True if the user is the author.
     */
    function isAuthor(docResource) {
      return isSignedIn() && request.auth.uid == docResource.data.userId;
    }

    /**
     * @description Rules for the roles_admin collection.
     * @path /roles_admin/{uid}
     * @allow (get) Signed-in user can check if they are an admin.
     * @deny (create, update, delete) Only the backend can manage admin roles.
     * @principle DBAC (Database-Based Access Control) - Admin status determined by document existence.
     */
    match /roles_admin/{uid} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for the users collection.
     * @path /users/{userId}
     * @allow (create) User can create their own profile.
     * @allow (get, update, delete) User can access and modify their own profile.
     * @deny (create) User cannot create a profile with a mismatched ID.
     * @deny (list) Listing users is not allowed.
     * @principle Enforces document ownership.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the orders subcollection under users.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create, get, update, delete) User can manage their own orders.
     * @deny (create, update, delete) User cannot manage orders for other users.
     * @deny (list) Listing orders is not allowed for other users.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the dielines subcollection under users.
     * @path /users/{userId}/dielines/{dielineId}
     * @allow (create, get, update, delete) User can manage their own dielines.
     * @deny (create, update, delete) User cannot manage dielines for other users.
     * @deny (list) Listing dielines is not allowed for other users.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/dielines/{dielineId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the AI reports subcollection under dielines under users.
     * @path /users/{userId}/dielines/{dielineId}/ai_reports/{aiReportId}
     * @allow (create, get, update, delete) User can manage their own AI reports.
     * @deny (create, update, delete) User cannot manage AI reports for other users.
     * @deny (list) Listing ai_reports is not allowed for other users.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/dielines/{dielineId}/ai_reports/{aiReportId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the products collection.
     * @path /products/{productId}
     * @allow (get, list) Publicly readable.
     * @allow (create, update, delete) Only admins can modify products.
     * @deny (create, update, delete) Non-admins cannot modify products.
     * @principle Public read, admin-only write.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

     /**
      * @description Rules for the invoices collection.
      * @path /invoices/{invoiceId}
      * @allow (get) Admins can read all invoices. Users can only read invoices associated with their orders.
      * @allow (create, update, delete) Only admins can manage invoices.
      * @deny (create, update, delete) Non-admins cannot manage invoices.
      * @principle Admin-only write, restricted read access.
      */
    match /invoices/{invoiceId} {
        allow get: if isAdmin();
        allow list: if isAdmin();
        allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Rules for the testimonials collection.
     * @path /testimonials/{testimonialId}
     * @allow (get, list) Publicly readable.
     * @allow (create) Any authenticated user can create a testimonial.
     * @allow (update, delete) Only the user who wrote the testimonial can edit or delete it.
     * @principle Community content with author-only modification.
     */
    match /testimonials/{testimonialId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAuthor(request.resource);
      allow update, delete: if isAuthor(resource);
    }
  }
}
